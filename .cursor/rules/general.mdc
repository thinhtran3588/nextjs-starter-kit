---
alwaysApply: true
---

# General instructions

## Documentation References

**CRITICAL**: When making code changes, always refer to the following documentation files:

- **[@README.md](../../README.md)**: Project overview, features, current status, and getting started
- **[@docs/architecture.md](../../docs/architecture.md)**: Clean Architecture and DDD principles, layer responsibilities, module structure, design patterns, and technology stack
- **[@docs/development-guide.md](../../docs/development-guide.md)**: Step-by-step guide for creating new features, including domain entities, use cases, repositories, routes, and testing
- **[@docs/testing-guide.md](../../docs/testing-guide.md)**: Testing practices, coverage requirements, and testing workflow

These documents contain the authoritative information about:

- Architecture patterns and layer responsibilities
- Module structure and organization
- Development workflows and best practices
- Code patterns and conventions
- Testing strategies

## Project Overview

The project follows Clean Architecture with a modular structure.

## Key Project Facts

- **Web Framework**: Next.js (App Router)
- **Language**: TypeScript (strict mode)
- **Module System**: Feature modules under `src/modules/{module-name}/`
- **Build Tool**: Next.js build pipeline
- **Source Directory**: `src/`
- **Module Structure**: `src/modules/{module-name}/` with `domain/`, `application/`, `infrastructure/`, and `adapters/` layers
- **Architecture**: Clean Architecture
- **Testing**: Vitest with 100% coverage requirement

## Common Libraries

- **UI & Styling**: Tailwind CSS, shadcn/ui
- **State**: Zustand
- **Forms & Validation**: React Hook Form, Zod
- **i18n**: next-intl
- **Testing**: Vitest, React Testing Library

## Essential Code Conventions

### File Naming

- Match existing patterns in the module and layer you are editing.
- Prefer descriptive, kebab-case filenames for feature artifacts.

### Code Style

- Prefer clarity and maintainability over cleverness.
- Keep responsibilities small and focused.

### Code Comments

**CRITICAL**: Do not write comments if the code is obvious. Code should be self-documenting through clear naming and structure.

**When NOT to add comments:**

- Don't comment what the code does - the code should be clear enough
- Don't add obvious comments like `// Set the user` above `user.set(...)`
- Don't add comments that just repeat the code
- Don't add comments for simple operations that are self-explanatory

**When to add comments:**

- Explain **why** something is done, not what is done
- Document non-obvious business logic or domain rules
- Explain workarounds or temporary solutions
- Clarify complex algorithms or non-intuitive implementations
- Document API contracts or external dependencies
- Explain performance optimizations or architectural decisions

**Principle**: If you need a comment to explain what the code does, consider refactoring the code to be more self-explanatory instead.

### Object Creation Pattern

**CRITICAL**: Do not create intermediate object variables if the object is only used once as a parameter to a function. Create the object inline instead.

**When NOT to create intermediate variables:**

- Don't create an object variable if it's only passed to a single function call
- Don't create intermediate variables for simple object literals that are only used once
- Prefer inline object creation for better readability and less code

**When to create intermediate variables:**

- The object is used multiple times
- The object needs to be modified before use
- The object is part of a complex transformation chain
- Creating the variable improves readability for very complex objects

**Examples:**

```typescript
// ❌ BAD - Unnecessary intermediate variable
const payload = {
  email,
  password,
  displayName,
};
return authApi.register(payload);

// ✅ GOOD - Inline object creation
return authApi.register({
  email,
  password,
  displayName,
});

// ✅ GOOD - Intermediate variable needed (used multiple times)
const formData = {
  email,
  password,
  displayName,
};
registerForm.reset(formData);
return authApi.register(formData);

// ✅ GOOD - Intermediate variable needed (modification required)
const request = {
  email,
  password,
  displayName,
};
if (inviteCode) {
  request.inviteCode = inviteCode;
}
return authApi.register(request);
```

**Principle**: Only create variables when they add value - either through reuse, modification, or improved readability for complex cases.

## Validation Ordering Pattern

Prefer local validation (schema, format, required fields) before any API calls. Avoid network requests when the payload is invalid or no updates are present. The server remains the source of truth and performs full validation.

### For Create Flows

**Order of validations:**

1. **Local validations first** - Zod schema parsing and client-side formatting
2. **Submit to API** - Only after local validation passes

**Example:**

```typescript
// 1. Local validation (throws if invalid)
const formData = registerSchema.parse(rawInput);

// 2. Submit to API only after local validation
return authApi.register(formData);
```

### For Update Flows

**Order of validations:**

1. **Local validations first** - Zod parsing and formatting
2. **Check for updates** - Skip the API call if nothing changed
3. **Submit to API** - Only when there are actual changes

**Example:**

```typescript
const updates = profileUpdateSchema.parse(rawInput);
const hasUpdates =
  updates.displayName !== undefined || updates.username !== undefined;

if (!hasUpdates) {
  return;
}

return profileApi.updateProfile(updates);
```

## Senior Architecture Guidance

- **Layering**: Domain must not depend on application or infrastructure.
- **Separation of concerns**: One responsibility per module/class.
- **Testability first**: Design choices must simplify testing.
- **Scalability**: Consider 10x/100x load, async work, and caching.
- **Security and validation**: Sanitize inputs, use value objects for format checks, and avoid logging secrets.
- **Performance**: Add indexes for hot queries, avoid N+1, use cursor pagination when needed.

## Validation Reminder

After making any code changes, run `npm run validate` unless the user explicitly asks to skip validation.
